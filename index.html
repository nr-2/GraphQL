<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GraphQL Dashboard</title>
  <link rel="stylesheet" href="css/styles.css">
  

  <link href="https://fonts.googleapis.com/css2?family=Exo:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  

</head>
<body>
  <div id="lines-container"></div>

  <div id="loader" class="loader"></div>

  <div id="loginBox" class="login-box">
    <h2>Welcome Back :</h2>
    <input type="text" id="loginUsername" placeholder="Username">
    <input type="password" id="loginPassword" placeholder="Password">
    <div id="loginError" class="error-message">Invalid credentials</div>
    <button id="loginButton" class="primary-button">Login to Dashboard</button>
  </div>

  <div id="dashboardContent">
    <header class="dashboard-header">
      <h1>GraphQL Dashboard</h1>
      <div class="header-buttons">
        <button id="logoutButton" class="primary-button">Logout</button>
      </div>
    </header>

    <main class="dashboard">
   <div class="card-row">
  <section id="userInfo" class="card">
    <h2>User Information</h2>
    <div id="userDetails">
      <p><strong>Username:</strong> <span id="username"></span></p>
      <p><strong>First Name:</strong> <span id="firstName"></span></p>
      <p><strong>Last Name:</strong> <span id="lastName"></span></p>
      <p><strong>Email:</strong> <span id="email"></span></p>
    </div>
  </section>

  

  <section id="auditSection" class="card audit-side">
    <h2>Audit Ratio</h2>
    <svg id="auditPie" width="200" height="200"></svg>
    <p id="auditText"></p>
  </section>
</div>

      <section id="progressSection" class="card">
        <h2>Progress Overview</h2>
        <div id="progressCard"></div>
        <div class="nav-buttons">
          <button class="primary-button" id="prevButton">Previous</button>
          <button class="primary-button" id="nextButton">Next</button>
        </div>
      </section>



  <section id="skillsSection" class="card" style="height: 500px;">
    <h2>Skills Overview</h2>
    <svg id="skillsGraph" width="100%" height="450"></svg>
  </section>


    </main>
  </div>

  

  <div id="tooltip" class="tooltip"></div>

  <script>
  const signinEndpoint = 'https://learn.reboot01.com/api/auth/signin';
const gqlEndpoint = 'https://learn.reboot01.com/api/graphql-engine/v1/graphql';

let jwtToken = null;
let progressData = [];
let currentProgressIndex = 0;


async function login(username, password) {
  const authHeader = 'Basic ' + btoa(`${username}:${password}`);
  const response = await fetch(signinEndpoint, {
    method: 'POST',
    headers: { Authorization: authHeader }
  });

  if (!response.ok) {
    console.error('Login failed with status:', response.status, 'Response:', await response.text());
    throw new Error('Invalid login');
  }
  jwtToken = await response.json();
  console.log('Successfully logged in. JWT Token received (not displayed for security, but exists).');
}

async function fetchGraphQL(query, variables = {}) {
  const response = await fetch(gqlEndpoint, {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${jwtToken}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ query, variables })
  });

  if (!response.ok) {
    const errorText = await response.text();
    console.error('GraphQL query failed with status:', response.status, 'Response:', errorText);
    throw new Error(`GraphQL query failed: ${errorText}`);
  }
  const responseJson = await response.json();
  console.log('GraphQL Response data:', responseJson.data);
  if (responseJson.errors) {
      console.error('GraphQL Errors from server:', responseJson.errors);
      throw new Error('GraphQL returned errors: ' + JSON.stringify(responseJson.errors));
  }
  return responseJson.data;
}

async function loadUserInfo() {
  const query = `{
    user {
      id
      login
      attrs
    }
  }`;
  try {
    const data = await fetchGraphQL(query);
    const user = data.user[0];
    document.getElementById('username').textContent = user.login;
    document.getElementById('firstName').textContent = user.attrs.firstName || 'N/A';
    document.getElementById('lastName').textContent = user.attrs.lastName || 'N/A';
    document.getElementById('email').textContent = user.attrs.email || 'N/A';
    console.log('User info loaded:', user.login);
  } catch (error) {
    console.error('Error loading user info:', error);
    document.getElementById('userInfo').innerHTML = '<p>Error loading user information.</p>';
  }
}

//audit
async function loadAuditData() {
  const query = `{
    transaction(where: {type: {_in: ["up", "down"]}}) {
      type
      amount
    }
  }`;
  try {
    const data = await fetchGraphQL(query);
    console.log('Audit data received:', data.transaction);
    let done = 0;
    let received = 0;

    data.transaction.forEach(tx => {
      if (tx.type === 'up') done += tx.amount;
      else if (tx.type === 'down') received += tx.amount;
    });

    const ratio = received > 0
      ? (Math.round((done / received) * 10) / 10).toFixed(1)
      : done > 0
      ? 'âˆž'
      : '0.0';

    const doneMB = (done / 1_000_000).toFixed(2);
    const receivedMB = (received / 1_000_000).toFixed(2);

    drawPie(done, received);
    document.getElementById('auditText').innerHTML =
      `Done: <strong>${doneMB} MB</strong><br>
      Received: <strong>${receivedMB} MB</strong><br>
      Ratio: <strong>${ratio}</strong> ${ratio >= 1.5 ? 'Almost perfect!' : ''}`;
    console.log('Audit data displayed.');
  } catch (error) {
    console.error('Error loading audit data:', error);
    document.getElementById('auditSection').innerHTML = '<p>Error loading audit data.</p>';
  }
}


async function loadSkillsAndXPData() {
  const query = `{
    transaction(where: { type: { _eq: "xp" } }) {
      amount
      path
      createdAt
    }
  }`;

  const data = await fetchGraphQL(query);
  const xpByProject = {};
  const xpByDate = {};

  data.transaction.forEach(tx => {
    const project = tx.path.split('/')[3] || 'unknown';
    const date = tx.createdAt.split('T')[0];

    xpByProject[project] = (xpByProject[project] || 0) + tx.amount;
    xpByDate[date] = (xpByDate[date] || 0) + tx.amount;
  });

  // XP in KB
  const skillsArray = Object.entries(xpByProject).map(([key, val]) => ({
    type: key,
    amount: val / 1000
  }));

  const xpOverTimeArray = Object.entries(xpByDate)
    .sort(([a], [b]) => a.localeCompare(b))
    .map(([key, val]) => ({
      date: key,
      amount: val / 1000
    }));

  drawSkills(skillsArray);
  drawXPOverTime(xpOverTimeArray);
}




function showProgress(index) {
  console.log('Attempting to show progress for index:', index);
  const progressCard = document.getElementById('progressCard');
  if (!progressCard) {
    console.error('progressCard element not found!');
    return;
  }

  if (progressData.length === 0) {
    progressCard.innerHTML = '<p>No graded progress found.</p>';
    document.getElementById('prevButton').disabled = true;
    document.getElementById('nextButton').disabled = true;
    console.log('showProgress: progressData is empty, disabling buttons.');
    return;
  }

  const item = progressData[index];
  if (item) {
    console.log('Displaying progress item:', item);
    progressCard.innerHTML = `
      <p><strong>Path:</strong> ${item.path}</p>
      <p><strong>Created At:</strong> ${new Date(item.createdAt).toLocaleString()}</p>
      <p><strong>Updated At:</strong> ${new Date(item.updatedAt).toLocaleString()}</p>
    `;
  } else {
    progressCard.innerHTML = '<p>Progress item not found at this index.</p>';
    console.warn('showProgress: Item not found at index', index);
  }

  const prevBtn = document.getElementById('prevButton');
  const nextBtn = document.getElementById('nextButton');
  if (prevBtn) prevBtn.disabled = index === 0;
  if (nextBtn) nextBtn.disabled = index === progressData.length - 1;
  console.log(`Progress nav buttons: Prev disabled = ${prevBtn?.disabled}, Next disabled = ${nextBtn?.disabled}`);
}

function bindProgressNavButtons() {
  const nextBtn = document.getElementById('nextButton');
  const prevBtn = document.getElementById('prevButton');

  if (!nextBtn || !prevBtn) {
    console.warn('Progress navigation buttons not found.');
    return;
  }

  nextBtn.addEventListener('click', () => {
    console.log('Next button clicked. Current index:', currentProgressIndex);
    if (currentProgressIndex < progressData.length - 1) {
      currentProgressIndex++;
      showProgress(currentProgressIndex);
    }
  });

  prevBtn.addEventListener('click', () => {
    console.log('Previous button clicked. Current index:', currentProgressIndex);
    if (currentProgressIndex > 0) {
      currentProgressIndex--;
      showProgress(currentProgressIndex);
    }
  });
  console.log('Progress navigation buttons bound.');
}

async function fetchProgress() {
  console.log('Starting fetchProgress...');
  const query = `{
    progress {
      path
      grade
      createdAt
      updatedAt
    }
  }`;

  try {
    const data = await fetchGraphQL(query);
    console.log('Raw progress data from GraphQL response:', data.progress);
    
    // Filter out items where grade is null
    let filteredProgress = data.progress.filter(p => p.grade !== null);
    
    // Sort progressData by createdAt in DESCENDING order (newest date first)
    progressData = filteredProgress.sort((a, b) => {
      return new Date(b.createdAt) - new Date(a.createdAt); // b - a for descending order
    });

    console.log('Filtered and sorted progressData (newest date first):', progressData);

    if (progressData.length === 0) {
      document.getElementById('progressCard').innerHTML = '<p>No graded progress found.</p>';
      document.getElementById('prevButton').disabled = true;
      document.getElementById('nextButton').disabled = true;
      console.log('No graded progress found. Progress section updated accordingly.');
      return;
    }

    // Reset currentProgressIndex to 0 to show the latest item initially
    currentProgressIndex = 0; 
    
    console.log('Current progress index after fetch, filter, sort, and adjustment:', currentProgressIndex);
    showProgress(currentProgressIndex);
    console.log('fetchProgress completed successfully.');
  } catch (error) {
    console.error('Error fetching progress data:', error);
    document.getElementById('progressCard').innerHTML = `<p>Error loading progress: ${error.message}</p>`;
    document.getElementById('prevButton').disabled = true;
    document.getElementById('nextButton').disabled = true;
  }
}

document.addEventListener('DOMContentLoaded', () => {
  bindProgressNavButtons();
  // Ensure that the initial display of progress (if already logged in, though usually not)
  // or after login will trigger fetchProgress.
});

async function loadDashboardData() {
  console.log('Loading all dashboard data...');
  await loadUserInfo();
  await loadAuditData();
  await loadSkillsAndXPData();
  await fetchProgress(); // This should now populate and display progress
  console.log('All dashboard data loaded.');
}

document.getElementById('loginButton').addEventListener('click', async () => {
  const username = document.getElementById('loginUsername').value;
  const password = document.getElementById('loginPassword').value;

  if (!username || !password) {
    document.getElementById('loginError').textContent = 'Please enter both username and password';
    document.getElementById('loginError').style.display = 'block';
    return;
  }

  try {
    document.getElementById('loader').style.display = 'block';
    document.getElementById('loginButton').disabled = true;
    document.getElementById('loginButton').textContent = 'Logging in...';
    document.getElementById('loginError').style.display = 'none';

    await login(username, password); // This sets jwtToken
    document.getElementById('loginBox').style.display = 'none';
    document.getElementById('dashboardContent').style.display = 'block';
    
    await loadDashboardData(); // This calls fetchProgress
  } catch (e) {
    document.getElementById('loginError').textContent = e.message;
    document.getElementById('loginError').style.display = 'block';
  } finally {
    document.getElementById('loader').style.display = 'none';
    document.getElementById('loginButton').disabled = false;
    document.getElementById('loginButton').textContent = 'Login to Dashboard';
  }
});

document.getElementById('logoutButton').addEventListener('click', () => {
  jwtToken = null;
  progressData = []; // Clear progress data on logout
  currentProgressIndex = 0; // Reset index
  document.getElementById('loginBox').style.display = 'block';
  document.getElementById('dashboardContent').style.display = 'none';
  document.getElementById('loginUsername').value = '';
  document.getElementById('loginPassword').value = '';
  document.getElementById('loginError').style.display = 'none';
  console.log('Logged out.');
});

function drawPie(done, received) {
  const width = 200;
  const height = 200;
  const radius = Math.min(width, height) / 2;

  d3.select('#auditPie').html('');

  const svg = d3.select('#auditPie')
    .attr('width', width)
    .attr('height', height)
    .append('g')
    .attr('transform', `translate(${width/2},${height/2})`);

  const data = [
    { label: 'Done', value: done },
    { label: 'Received', value: received }
    ];

  const color = d3.scaleOrdinal()
    .domain(data.map(d => d.label))
    .range(['#1cb39b', '#F44336']);

  const pie = d3.pie()
    .value(d => d.value)
    .sort(null);

  const arc = d3.arc()
    .innerRadius(radius * 0.6)
    .outerRadius(radius);

  const arcTween = d => {
    const i = d3.interpolate({startAngle: 0, endAngle: 0}, d);
    return t => arc(i(t));
  };

  const tooltip = d3.select('#tooltip');

  const paths = svg.selectAll('path')
    .data(pie(data))
    .enter()
    .append('path')
    .attr('d', arc)
    .attr('fill', d => color(d.data.label))
    .attr('stroke', '#333')
    .attr('stroke-width', 2)
    .style('opacity', 0.9)
    .on('mouseover', function(event, d) {
      d3.select(this).transition().duration(300).style('opacity', 1).attr('transform', 'scale(1.05)');
      tooltip.style('opacity', 0.9)
        .style('left', (event.pageX + 10) + 'px')
        .style('top', (event.pageY - 25) + 'px')
        .html(`${d.data.label}: ${d.data.value} MB`);
    })
    .on('mouseout', function() {
      d3.select(this).transition().duration(300).style('opacity', 0.9).attr('transform', 'scale(1)');
      tooltip.style('opacity', 0);
    });

  paths.transition()
    .duration(1000)
    .attrTween('d', arcTween);

  const ratio = Math.round((done / received) * 10) / 10;

  svg.append('text')
    .attr('text-anchor', 'middle')
    .attr('dy', '.35em') // perfect vertical centering
    .style('font-size', '16px')
    .style('font-weight', '600')
    .style('fill', '#fff')
    .style('opacity', 0)
    .text(`Ratio: ${ratio}`)
    .transition()
    .duration(800)
    .style('opacity', 1);
}

function drawXPOverTime(data) {
    console.log('drawXPOverTime called with data:', data);
    // This function needs to be fully implemented if you want to display XP over time.
    // If not, you can remove the call to it in loadSkillsAndXPData.
}

  // Background animation setup
    function createLines() {
      const container = document.getElementById('lines-container');
      const lineCount = window.innerWidth < 768 ? 8 : 15;
      
      for (let i = 0; i < lineCount; i++) {
        const line = document.createElement('div');
        line.classList.add('line');
        
        // Random positioning and styling
        const width = Math.random() * 100 + 50; // Random width between 50-150px
        const top = Math.random() * 100; // Random vertical position
        const delay = Math.random() * 5; // Random animation delay
        const duration = 5 + Math.random() * 5; // Random duration 5-10s
        
        line.style.width = `${width}px`;
        line.style.top = `${top}%`;
        line.style.opacity = '0';
        line.style.animationDelay = `${delay}s`;
        line.style.animationDuration = `${duration}s`;
        
        container.appendChild(line);
      }
    }
    
    createLines();
    
    // Recreate lines on window resize
    window.addEventListener('resize', () => {
      const container = document.getElementById('lines-container');
      container.innerHTML = '';
      createLines();
    });





    // Login handling 
    document.getElementById('loginButton').addEventListener('click', async () => {
      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;
      
      if (!username || !password) {
        document.getElementById('loginError').textContent = 'Please enter both username and password';
        document.getElementById('loginError').style.display = 'block';
        return;
      }

      try {
        // Show loading indicator
        document.getElementById('loader').style.display = 'block';
        document.getElementById('loginButton').disabled = true;
        document.getElementById('loginButton').textContent = 'Logging in...';
        document.getElementById('loginError').style.display = 'none';
        
        const authHeader = 'Basic ' + btoa(username + ':' + password);
        
        // Simulate network delay
        await new Promise(resolve => setTimeout(resolve, 800));
        
        const response = await fetch('https://learn.reboot01.com/api/auth/signin', {
          method: 'POST',
          headers: { 'Authorization': authHeader }
        });

        if (!response.ok) throw new Error('Login failed');
        
        document.getElementById('loginBox').style.display = 'none';
        document.getElementById('dashboardContent').style.display = 'block';
        document.querySelector('.dashboard-header').style.display = 'flex';
        document.querySelector('.dashboard').style.display = 'block';
        
        loadDashboardData();
      } catch (e) {
        document.getElementById('loginError').textContent = 'Invalid credentials. Please try again.';
        document.getElementById('loginError').style.display = 'block';
      } finally {
        // Hide loading indicator
        document.getElementById('loader').style.display = 'none';
        document.getElementById('loginButton').disabled = false;
        document.getElementById('loginButton').textContent = 'Login to Dashboard';
      }
    });
    
    // Enter key to login
    document.getElementById('loginPassword').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('loginButton').click();
      }
    });

    // Logout handling
    document.getElementById('logoutButton').addEventListener('click', () => {
      document.getElementById('loginBox').style.display = 'block';
      document.getElementById('dashboardContent').style.display = 'none';
      document.getElementById('loginUsername').value = '';
      document.getElementById('loginPassword').value = '';
      document.getElementById('loginError').style.display = 'none';
    });
    


    // Typing animation effect
    function typeWriter(element, text, speed = 50) {
      let i = 0;
      element.textContent = '';
      
      function type() {
        if (i < text.length) {
          element.textContent += text.charAt(i);
          i++;
          setTimeout(type, speed);
        }
      }
      
      type();
    }
    
    // Draw skills bar chart with improved visuals and interactions
function drawSkills(skills) {
  // Round up to nearest .10 if not already .x0
  function roundToNextTenth(value) {
    return Math.ceil(value * 10) / 10;
  }

  // Filter and format skill values
  skills = skills
    .filter(skill => {
      const type = skill.type.toLowerCase();
      return !type.includes("quest") && !type.includes("checkpoint") && !type.includes("piscine-js");
    })
    .map(skill => ({
      ...skill,
      amount: roundToNextTenth(skill.amount)
    }));

  const margin = { top: 20, right: 30, bottom: 40, left: 50 };
  const width = document.getElementById('skillsGraph').clientWidth - margin.left - margin.right;
  const height = 300 - margin.top - margin.bottom;

  d3.select('#skillsGraph').html('');

  const svg = d3.select('#skillsGraph')
    .attr('width', width + margin.left + margin.right)
    .attr('height', height + margin.top + margin.bottom)
    .append('g')
    .attr('transform', `translate(${margin.left},${margin.top})`);

  const x = d3.scaleBand()
    .range([0, width])
    .padding(0.2)
    .domain(skills.map(d => d.type));

  const maxKB = d3.max(skills, d => d.amount);
  const y = d3.scaleLinear()
    .range([height, 0])
    .domain([0, maxKB + maxKB * 0.2]);

  svg.append('g')
    .attr('transform', `translate(0,${height})`)
    .call(d3.axisBottom(x).tickFormat(''))
    .selectAll('text').remove();

  svg.append('g')
    .call(d3.axisLeft(y).ticks(5))
    .selectAll('text')
    .style('fill', 'var(--font--paragraph)')
    .style('font-size', '12px');

  svg.append('text')
    .attr('transform', 'rotate(-90)')
    .attr('y', -margin.left + 20)
    .attr('x', -height / 2)
    .attr('text-anchor', 'middle')
    .style('fill', 'var(--font--paragraph)')
    .text('kB');

  svg.append('text')
    .attr('y', height + margin.bottom - 5)
    .attr('x', width / 2)
    .attr('text-anchor', 'middle')
    .style('fill', 'var(--font--paragraph)')
    .text('Skills');

  const tooltip = d3.select('#tooltip');

  svg.selectAll('.bar')
    .data(skills)
    .enter().append('rect')
    .attr('class', 'bar')
    .attr('x', d => x(d.type))
    .attr('width', x.bandwidth())
    .attr('y', height)
    .attr('height', 0)
    .attr('fill', d => d3.interpolateRgb('#189985', '#1cb39b')(d.amount / maxKB))
    .attr('rx', 4)
    .attr('ry', 4)
    .on('mouseover', function(event, d) {
      d3.select(this)
        .transition()
        .duration(300)
        .attr('fill', '#20d0b5');

      tooltip.style('opacity', 0.9)
        .style('left', `${event.pageX + 10}px`)
        .style('top', `${event.pageY - 25}px`)
        .html(`${d.type}: ${d.amount.toFixed(2)} kB`);
    })
    .on('mouseout', function(event, d) {
      d3.select(this)
        .transition()
        .duration(300)
        .attr('fill', d3.interpolateRgb('#189985', '#1cb39b')(d.amount / maxKB));

      tooltip.style('opacity', 0);
    })
    .transition()
    .duration(800)
    .delay((_, i) => i * 150)
    .attr('y', d => y(d.amount))
    .attr('height', d => height - y(d.amount));

  svg.selectAll('.value-label')
    .data(skills)
    .enter()
    .append('text')
    .attr('class', 'value-label')
    .attr('x', d => x(d.type) + x.bandwidth() / 2)
    .attr('y', d => y(d.amount) - 5)
    .attr('text-anchor', 'middle')
    .style('fill', 'var(--font--heading-primary)')
    .style('font-size', '12px')
    .style('opacity', 0)
    .text(d => `${d.amount.toFixed(2)} kB`)
    .transition()
    .duration(800)
    .delay((_, i) => i * 150 + 400)
    .style('opacity', 1);
}

</script>
<script type="module" src="./js/main.js"></script>



</body>
</html>